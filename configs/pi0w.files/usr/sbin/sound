#!/bin/sh

JACKNAME=default

exec 1>/tmp/sound.log
exec 2>&1

# increase priority of apps by this amount
PROC_PRI=20

# set up IRQs (default 51)  with higher priority- USB and wifi mmc
IRQ_PRI=53
IRQS="35 36 37 49 50"
for irq in $IRQS; do chrt -fp $IRQ_PRI $irq; done

start=
while true; do
	sleep 1
	jackpid=`pgrep jackd` || {
		echo "Starting Jack"
		jackd -R -P$PROC_PRI -d alsa -r 48000 -zs -s -i2 -o2 -n2 -p2048 &
		start=1
		continue
	}
	
	jackres=`jack_wait -c -s $JACKNAME 2>/dev/null | tail -n1` && [ "$jackres" == "running" ] || continue
	
	# check if jconvolver running
	convpid=`pgrep jconvolver` || {
		echo "Starting convolver"
		jconvolver -s $JACKNAME /root/convolver.jconv &
		echo "Started..."
		start=2
		continue
	}
	
	# check if zita-n2j running
	zitapid=`pgrep zita-n2j` || {
		echo "Starting zita-n2j"
		/etc/init.d/zita-n2j start
		echo "Started..."		
		start=3		
		continue
	}
	
	/etc/init.d/mpd start

	# run jack event monitor in background- sending output to named pipe. wait for data on the pipe-
	# specifically "Client wifi-n2j registered" type events- which we will use to trigger connects
	# dbus-monitor --monitor  "type=signal,path=/org/jackaudio/Controller,interface='org.jackaudio.JackPatchbay',member=PortAppeared"
	[ -n "$start" ] && {
		echo "Started audio ($start) jackd($jackpid) jconvolver($convpid) n2j($zitapid)"
		alsactl --file /root/asound.audioinjector.no.in restore
#		alsactl --file /root/asound.audioinjector.line.in restore
		start=
	}
	sleep 3
done;

